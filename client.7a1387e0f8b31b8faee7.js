(()=>{"use strict";class e extends EventTarget{constructor(e){super();for(const t of e)this.init(t)}init(e){Object.defineProperty(this,`on${e}`,{set(t){this.on(e,t)}})}on(e,t){this.addEventListener(e,t)}emit(e,t){this.dispatchEvent(new CustomEvent(e,{detail:t}))}}const t=e,n=class extends t{constructor(e){super(["open","message","close"]),this.id=e,this.peerConnections={},this.dataChannels={}}async createOffer(e){this.peerConnections[e]=new RTCPeerConnection,this.dataChannels[e]=await this.peerConnections[e].createDataChannel(e),this.setupPeerConnection(e),this.setupDataChannel(e);const t=await this.peerConnections[e].createOffer();return await this.peerConnections[e].setLocalDescription(t),await new Promise(((t,n)=>{this.peerConnections[e].onicecandidate=n=>{t(this.peerConnections[e].localDescription)}}))}async createAnswer(e,t){this.peerConnections[e]=new RTCPeerConnection,this.peerConnections[e].addEventListener("datachannel",(t=>{this.dataChannels[e]=t.channel,this.setupDataChannel(e)})),this.setupPeerConnection(e),await this.peerConnections[e].setRemoteDescription(t);const n=await this.peerConnections[e].createAnswer();return await this.peerConnections[e].setLocalDescription(n),n}async setAnswer(e,t){await this.peerConnections[e].setRemoteDescription(t)}setupPeerConnection(e){this.peerConnections[e].addEventListener("connectionstatechange",(t=>{"disconnected"!=t.target.connectionState&&"failed"!=t.target.connectionState||this.close(e)}))}setupDataChannel(e){this.dataChannels[e].addEventListener("open",(t=>{this.emit("open",[e,t])})),this.dataChannels[e].addEventListener("message",(t=>{this.emit("message",[e,t])}))}close(e){this.peerConnections[e]&&(this.dataChannels[e].close(),this.peerConnections[e].close(),delete this.dataChannels[e],delete this.peerConnections[e])}send(e,t){this.dataChannels[e].send(JSON.stringify(t))}},s={};s.PeerDHT=class extends n{constructor(e,t,n){super(e),this.publicKey=t,this.privateKey=n,this.neighbors=new Set,this.state="new",this.on("open",(e=>{const[t,n]=e.detail;this.send(t,{event:"neighbors",data:{neighbors:Array.from(this.neighbors)}})})),this.on("message",(async e=>{const[t,n]=e.detail,s=JSON.parse(n.data);if("neighbors"==s.event)console.log(s.data.neighbors),this.nearestNeighbor(this.id,[...s.data.neighbors,t])==t?(this.neighbors.add(t),this.state="bootstraped"):"new"==this.state&&(this.neighbors.add(t),this.relay(t,this.id,{event:"connect",sender:this.id,recipient:this.id}));else if("relay"==s.event)if(this.nearestNeighbor(s.recipient,[...this.neighbors,this.id])==this.id&&(s.recipient=this.id),this.id==s.recipient){if("connected"==this.peerConnections[s.data.recipient]?.connectionState)this.send(s.data.recipient,{event:"relay",sender:s.sender,recipient:s.data.recipient,data:s.data});else if("connect"==s.data.event){const e=JSON.stringify(await this.createOffer(s.data.sender));this.relay(s.recipient,s.sender,{event:"offer",sender:this.id,recipient:s.data.sender,offer:e})}else if("offer"==s.data.event){const e=JSON.parse(s.data.offer),t=JSON.stringify(await this.createAnswer(s.data.sender,e));this.relay(s.recipient,s.sender,{event:"answer",sender:this.id,recipient:s.data.sender,answer:t})}else if("answer"==s.data.event){const e=JSON.parse(s.data.answer);await this.setAnswer(s.data.sender,e)}}else this.relay(s.sender,s.recipient,s.data)}))}distance(e,t){return Math.abs(parseInt(e)-parseInt(t))}nearestNeighbor(e,t){var n,s=1/0;for(const a of t){var i=this.distance(e,a);s>i&&(s=i,n=a)}return n}relay(e,t,n){const s=this.nearestNeighbor(t,this.neighbors);this.send(s,{event:"relay",sender:e,recipient:t,data:n})}async encrypt(e,t){return window.crypto.subtle.encrypt({name:"RSA-OAEP"},e,t)}async decrypt(e,t){return window.crypto.subtle.decrypt({name:"RSA-OAEP"},e,t)}async importPublicKey(e){return window.crypto.subtle.importKey("spki",e,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"])}};const i=s;var a,r,o;const c=async()=>{document.querySelector(".answer-btn").removeEventListener("click",h);const e=document.querySelector(".hash-inp").value,t=await o.createOffer(e),n=document.createElement("a"),s=new Blob([JSON.stringify({uHexHash:r,sdp:t})],{type:"text/sdp"}),i=window.URL.createObjectURL(s);n.href=i,n.download="offer.sdp",n.click(),window.URL.revokeObjectURL(i),document.querySelector(".answer-btn").addEventListener("click",d)},d=async()=>{let e=new FileReader;e.readAsText(document.querySelector(".file-inp").files[0]),e.onload=async()=>{const t=JSON.parse(e.result).sdp,n=JSON.parse(e.result).uHexHash;await o.setAnswer(n,t),document.querySelector(".answer-btn").removeEventListener("click",d),document.querySelector(".answer-btn").addEventListener("click",h)}},h=async()=>{let e=new FileReader;e.readAsText(document.querySelector(".file-inp").files[0]),e.onload=async()=>{const t=JSON.parse(e.result).sdp,n=JSON.parse(e.result).uHexHash;document.querySelector(".hash-inp").value=n;const s=await o.createAnswer(n,t),i=document.createElement("a"),a=new Blob([JSON.stringify({uHexHash:r,sdp:s})],{type:"text/sdp"}),c=window.URL.createObjectURL(a);i.href=c,i.download="answer.sdp",i.click(),window.URL.revokeObjectURL(c)}};!async function(){const e=await(async()=>window.crypto.subtle.generateKey({name:"RSA-OAEP",modulusLength:4096,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"},!0,["encrypt","decrypt"]))(),t=e.publicKey,n=e.privateKey;await(async e=>await window.crypto.subtle.exportKey("spki",e))(t),a=new String(Math.floor(1e3*Math.random())),r=a,(o=new i.PeerDHT(r,t,n)).on("message",(e=>{const[t,n]=e.detail,s=JSON.parse(n.data);console.log(s)})),document.querySelector(".hash").innerHTML=r,document.querySelector(".offer-btn").addEventListener("click",c),document.querySelector(".answer-btn").addEventListener("click",h),document.querySelector(".test").addEventListener("click",(()=>{console.log(o.neighbors),console.log(o.state)}))}()})();